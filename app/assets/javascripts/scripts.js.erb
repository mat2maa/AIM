var video1_dom, video2_dom, video1, video2, href, step;


$(document).ready(function () {

  video1_dom = $('#video-background-1');
  video2_dom = $('#video-background-2');
  video1 = video1_dom.get(0);
  video2 = video2_dom.get(0);

  $(document).pjax('a', '[data-pjax-container]');

  $(document).on('submit', 'form', function (event) {
    $.pjax.submit(event, '[data-pjax-container]')
  });

  $(document).on('pjax:start', function () {
    console.log("pjax:start");
  });
  $(document).on('pjax:end', function () {
    console.log("pjax:end");
    videoSwitch();
  });
  $(document).on('pjax:click', function () {
    console.log("pjax:click");
  });
  $(document).on('pjax:beforeSend', function () {
    console.log("pjax:beforeSend");
  });
  $(document).on('pjax:send', function () {
    console.log("pjax:send");
  });
  $(document).on('pjax:complete', function () {
    console.log("pjax:complete");
  });
  $(document).on('pjax:success', function () {
    console.log("pjax:success");
  });
  $(document).on('pjax:error', function () {
    console.log("pjax:error");
  });
  $(document).on('pjax:timeout', function () {
    console.log("pjax:timeout");
  });

  //enable select2 js
  $('.select2').select2();

  $('body').append('<div id="action-button" style="position: fixed; top: 0; left: 0; width: 100px; height: 50px; background-color: cadetblue; z-index: 3000; cursor: pointer;">Click!</div>');

  $('body').on("click", "#action-button", function () {
    video1_dom.css('z-index', 2);
    video2_dom.css('z-index', 1);
    playVideo(video1, 0, 1);
  });
});

$(document).on('nested:fieldAdded', function (event) {
  $('select.select2').select2();
});

$(window).load(function () {
  var sound;


  video1_dom = $('#video-background-1');
  video2_dom = $('#video-background-2');
  video1 = video1_dom.get(0);
  video2 = video2_dom.get(0);
  videoSwitch();

  if ($('.audio-player')) {
    sound = $('.audio-player').attr('data-audio-file');
  }
  soundManager.setup({
    url: '/path/to/swf-files/',
    // optional: use 100% HTML5 mode where available
    // preferFlash: false,
    onready: function () {
      var mySound = soundManager.createSound({
        id: 'aSound',
        url: sound
      });
      $('.play-button').on("click", function (e) {
        e.preventDefault();
        mySound.play();
      });
      $('.stop-button').on("click", function (e) {
        e.preventDefault();
        mySound.stop();
      });
      $('.pause-button').on("click", function (e) {
        e.preventDefault();
        mySound.pause();
      });
    },
    ontimeout: function () {
      // Hrmm, SM2 could not start. Missing SWF? Flash blocked? Show an error, etc.?
    }
  });
});

function videoSwitch() {
  href = window.location.href.split('/');
  step = href[href.length - 1];

  switch (step) {
    case "edit":
      video1.currentTime = 0;
      $('.video > video').css({'opacity': 1.0});
      playVideo(video1, 0, 1);
      break;
    default:
      $('.video > video').css({'opacity': 0.0});
      break;
  }
}

function playVideo(videoAsset, start, end) {
  var startTime = start,
      endTime = end,
      video = videoAsset;

  //handler should be bound first
  video.addEventListener("timeupdate", function () {
    if (this.currentTime >= endTime) {
      this.pause();
        playSecond();
    }
  }, false);

  video.play();
  try {
    video.currentTime = startTime;
  } catch (ex) {
    //handle exceptions here
  }
}

function playSecond() {
  video1_dom.css('z-index', 1);
  video2_dom.css('z-index', 2);
  playVideo(video2, 0, 1);
}
